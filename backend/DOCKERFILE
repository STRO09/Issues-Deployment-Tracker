# ===== Stage 1: Build with Maven =====
FROM maven:3.8.5-openjdk-8 AS builder
WORKDIR /app

# Copy pom.xml and download dependencies first (better cache)
COPY pom.xml .
RUN mvn dependency:go-offline -B

# Copy source and build WAR
COPY src ./src
RUN mvn -B clean package -DskipTests


# ===== Stage 2: Tomcat runtime =====
FROM eclipse-temurin:8-jdk-alpine

# Install wget and unzip
RUN apk add --no-cache wget bash tar

# Set Tomcat environment
ENV TOMCAT_VER=9.0.80
ENV CATALINA_HOME=/usr/local/tomcat
ENV PATH=$CATALINA_HOME/bin:$PATH

# Download Tomcat from archive (since 9.0.80 is old)
RUN wget https://archive.apache.org/dist/tomcat/tomcat-9/v$TOMCAT_VER/bin/apache-tomcat-$TOMCAT_VER.tar.gz \
    && mkdir -p $CATALINA_HOME \
    && tar xzf apache-tomcat-$TOMCAT_VER.tar.gz -C $CATALINA_HOME --strip-components=1 \
    && rm apache-tomcat-$TOMCAT_VER.tar.gz

    #remove default root.war in tomcat webapps
RUN rm -rf $CATALINA_HOME/webapps/*

# Fix Tomcat port to use Render's PORT environment variable
RUN sed -i "s/port=\"8080\"/port=\"${PORT:-10000}\"/" $CATALINA_HOME/conf/server.xml

# Copy WAR from builder stage
COPY --from=builder /app/target/IssuesandDeploymentTracker-0.0.1-SNAPSHOT.war $CATALINA_HOME/webapps/ROOT.war

# Expose Tomcat port
EXPOSE 10000

# Run Tomcat
CMD ["sh", "-c", "$CATALINA_HOME/bin/catalina.sh run"]

