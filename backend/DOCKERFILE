# Use Maven + JDK 8 to build
FROM maven:3.9.6-openjdk-8 AS builder
WORKDIR /app

# Copy source and build WAR
COPY pom.xml .
COPY src ./src
RUN mvn -B clean package -DskipTests

# Stage 2: Run with Tomcat
FROM openjdk:8-jdk-alpine

# Install wget and tar
RUN apk add --no-cache wget bash tar

# Set Tomcat environment
ENV TOMCAT_VER=9.0.80
ENV CATALINA_HOME=/usr/local/tomcat
ENV PATH=$CATALINA_HOME/bin:$PATH

# Download Tomcat from archive
RUN wget https://archive.apache.org/dist/tomcat/tomcat-9/v$TOMCAT_VER/bin/apache-tomcat-$TOMCAT_VER.tar.gz \
    && mkdir -p $CATALINA_HOME \
    && tar xzf apache-tomcat-$TOMCAT_VER.tar.gz -C $CATALINA_HOME --strip-components=1 \
    && rm apache-tomcat-$TOMCAT_VER.tar.gz

# Copy WAR from builder
COPY --from=builder /app/target/IssuesandDeploymentTracker-0.0.1-SNAPSHOT.war $CATALINA_HOME/webapps/ROOT.war

EXPOSE 8080
CMD ["catalina.sh", "run"]
